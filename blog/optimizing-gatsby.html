<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1" class="jsx-3747868491 next-head"/><meta charSet="utf-8" class="jsx-3747868491 next-head"/><title class="jsx-3747868491 next-head">Kameron</title><meta name="description" content="
I&#x27;ve been getting cuddly with [Gatsby](https://www.gatsbyjs.org/) over the last 5 months as my new role at [Tray.io](https://tray.io) requires me to oversee the development of their marketing site." class="jsx-3747868491 next-head"/><meta property="og:title" content="Optimizing Gatsby" class="next-head"/><meta property="og:site_name" content="https://kamerontanseli.github.io/" class="next-head"/><meta property="og:url" content="https://kamerontanseli.github.io/blog/optimizing-gatsby" class="next-head"/><meta property="og:description" content="
I&#x27;ve been getting cuddly with [Gatsby](https://www.gatsbyjs.org/) over the last 5 months as my new role at [Tray.io](https://tray.io) requires me to oversee the development of their marketing site." class="next-head"/><meta property="og:type" content="article" class="next-head"/><meta property="og:image" content="../static/posts/34442516-fb1a1a3c-ecc2-11e7-8fe8-530435f22336.jpg" class="next-head"/><link rel="preload" href="/_next/static/sKigvmBxHeR5ojdFW8lLh/pages/blog/[slug].js" as="script"/><link rel="preload" href="/_next/static/sKigvmBxHeR5ojdFW8lLh/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-e1f7b6ddb3fae2db1f5d.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.0647a33e7070b3b816f2.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-f116230a2e83c52060c3.js" as="script"/><style id="__jsx-3747868491">@import url("https://fonts.googleapis.com/css?family=Work+Sans&display=swap");*{box-sizing:inherit;}html{box-sizing:border-box;overflow-y:scroll;}body{margin:0;font-family:"Work Sans","Helvetica Neue",Helvetica,sans-serif;overflow-x:hidden;color:#000;font-size:16px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}a{-webkit-text-decoration:none;text-decoration:none;color:inherit;-webkit-transition:opacity 0.2s ease;transition:opacity 0.2s ease;}a:hover{-webkit-transition:opacity 0.2s ease;transition:opacity 0.2s ease;opacity:0.5;-webkit-text-decoration-color:inherit;text-decoration-color:inherit;}ul{list-style:none;margin:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;list-style-position:outside;list-style-image:none;}ol{margin:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;list-style-position:outside;list-style-image:none;}ul,ol,p{margin-bottom:1.45rem;}img{max-width:100%;}img,figure,table,fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}pre{margin-left:0;margin-right:0;margin-top:0;margin-bottom:1.45rem;font-size:0.85rem;line-height:1.42;background:hsla(0,0%,0%,0.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem;}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%;}blockquote{margin-left:1.45rem;margin-right:1.45rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}strong{font-weight:bold;}li{margin-bottom:calc(1.45rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li>ol{margin-left:1.45rem;margin-bottom:calc(1.45rem / 2);margin-top:calc(1.45rem / 2);}li>ul{margin-left:1.45rem;margin-bottom:calc(1.45rem / 2);margin-top:calc(1.45rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li>p{margin-bottom:calc(1.45rem / 2);}code{font-size:0.85rem;line-height:1.45rem;}h1,h2,h3,h4,h5,h6,p{font-family:"Work Sans","Helvetica Neue",Helvetica,sans-serif;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:inherit;text-rendering:optimizeLegibility;}h1,h2{font-weight:500;}h1{font-size:2rem;-webkit-letter-spacing:-1px;-moz-letter-spacing:-1px;-ms-letter-spacing:-1px;letter-spacing:-1px;line-height:1.1875;}h2{font-size:1.7rem;-webkit-letter-spacing:-0.75px;-moz-letter-spacing:-0.75px;-ms-letter-spacing:-0.75px;letter-spacing:-0.75px;line-height:1.2;}h3{font-size:1.2rem;-webkit-letter-spacing:-0.5px;-moz-letter-spacing:-0.5px;-ms-letter-spacing:-0.5px;letter-spacing:-0.5px;line-height:1.1875;color:#a0a0a0;font-weight:normal;}p{font-size:1.2rem;-webkit-letter-spacing:-0.5px;-moz-letter-spacing:-0.5px;-ms-letter-spacing:-0.5px;letter-spacing:-0.5px;line-height:1.5;color:#464646;}@media (min-width:1280px){h1{font-size:2rem;-webkit-letter-spacing:-1px;-moz-letter-spacing:-1px;-ms-letter-spacing:-1px;letter-spacing:-1px;line-height:1.1875;}h2{font-size:1.5rem;-webkit-letter-spacing:-0.75px;-moz-letter-spacing:-0.75px;-ms-letter-spacing:-0.75px;letter-spacing:-0.75px;line-height:1.1667;}h3{font-size:1rem;-webkit-letter-spacing:-0.5px;-moz-letter-spacing:-0.5px;-ms-letter-spacing:-0.5px;letter-spacing:-0.5px;line-height:1.1875;color:#a0a0a0;font-weight:normal;}p{line-height:1.4375;}}</style><style id="__jsx-2864913490">h1.jsx-2864913490{margin-bottom:0;}h1.jsx-2864913490:hover{cursor:pointer;}nav.jsx-2864913490{padding:1.5rem 1.25rem;border-bottom:1px solid #ebebeb;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}@media (min-width:768px){.header.jsx-2864913490{height:100vh;position:fixed;left:0;top:0;}.nav.jsx-2864913490{padding:2rem;width:30vw;height:100%;border-right:1px solid #ebebeb;border-bottom:none;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}</style><style id="__jsx-560623522">.blog.jsx-560623522 h1.jsx-560623522{margin-bottom:0.7rem;}.blog__hero.jsx-560623522{min-height:300px;height:60vh;width:100%;margin:0;overflow:hidden;}.blog__hero.jsx-560623522 img.jsx-560623522{margin-bottom:0;object-fit:cover;min-height:100%;min-width:100%;object-position:center;}.blog__info.jsx-560623522{padding:1.5rem 1.25rem;width:100%;max-width:768px;margin:0 auto;}.blog__info.jsx-560623522 h1.jsx-560623522{margin-bottom:0.66rem;}.blog__info.jsx-560623522 h3.jsx-560623522{margin-bottom:0;}.blog__body.jsx-560623522{width:100%;padding:0 1.25rem;margin:0 auto;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}.blog__body.jsx-560623522 a{color:#2196f3 !important;}.blog__body.jsx-560623522:last-child{margin-bottom:0;}.blog__body.jsx-560623522 h1.jsx-560623522 h2.jsx-560623522 h3.jsx-560623522 h4.jsx-560623522 h5.jsx-560623522 h6.jsx-560623522 p.jsx-560623522{font-weight:normal;}.blog__body.jsx-560623522 p.jsx-560623522{color:inherit;}.blog__body.jsx-560623522 ul.jsx-560623522{list-style:initial;}.blog__body.jsx-560623522 ul.jsx-560623522 ol.jsx-560623522{margin-left:1.25rem;margin-bottom:1.25rem;padding-left:1.45rem;}.blog__footer.jsx-560623522{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:1.5rem 1.25rem;width:100%;max-width:800px;margin:0 auto;}.blog__footer.jsx-560623522 h2.jsx-560623522{margin-bottom:0;}.blog__footer.jsx-560623522 a.jsx-560623522{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.blog__footer.jsx-560623522 a.jsx-560623522 svg.jsx-560623522{width:20px;}@media (min-width:768px){.blog.jsx-560623522{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.blog__body.jsx-560623522{max-width:800px;padding:0 2rem;}.blog__body.jsx-560623522 span.jsx-560623522{width:100%;margin:1.5rem auto;}.blog__body.jsx-560623522 ul.jsx-560623522 ol.jsx-560623522{margin-left:1.5rem;margin-bottom:1.5rem;}.blog__hero.jsx-560623522{min-height:600px;height:75vh;}.blog__info.jsx-560623522{text-align:center;padding:2rem 0;}.blog__info.jsx-560623522 h1.jsx-560623522{margin:0 auto 0.66rem auto;}.blog__footer.jsx-560623522{padding:2.25rem;}}@media (min-width:1440px){.blog__hero.jsx-560623522{height:70vh;}.blog__info.jsx-560623522{padding:3rem 0;}.blog__footer.jsx-560623522{padding:2rem 2rem 3rem 2rem;}}</style><style id="__jsx-2857272008">.layout.jsx-2857272008{overflow-x:hidden;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100vh;}.layout.jsx-2857272008 .info_page.jsx-2857272008{color:#ebebeb;}.content.jsx-2857272008{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}@media (min-width:768px){.layout.jsx-2857272008{display:block;}.content.jsx-2857272008{-webkit-box-flex:none;-webkit-flex-grow:none;-ms-flex-positive:none;flex-grow:none;width:70vw;margin-left:30vw;}}</style></head><body><div id="__next"><section style="background-color:undefined;color:false" class="jsx-2857272008 layout false"><header class="jsx-2864913490 header"><nav role="navigation" aria-label="main navigation" class="jsx-2864913490 nav"><a href="/" class="jsx-2864913490"><h1 class="jsx-2864913490">Kameron</h1></a><div class="jsx-2864913490"><a href="/info" class="jsx-2864913490"><h1 class="jsx-2864913490">info</h1></a></div></nav></header><div class="jsx-2857272008 content"><article class="jsx-560623522 blog"><figure class="jsx-560623522 blog__hero"><img src="../static/posts/34442516-fb1a1a3c-ecc2-11e7-8fe8-530435f22336.jpg" alt="blog_hero_Optimizing Gatsby" class="jsx-560623522"/></figure><div class="jsx-560623522 blog__info"><h1 class="jsx-560623522">Optimizing Gatsby</h1><h3 class="jsx-560623522">May 01 2020</h3></div><div class="jsx-560623522 blog__body"><p>I&#x27;ve been getting cuddly with <a href="https://www.gatsbyjs.org/">Gatsby</a> over the last 5 months as my new role at <a href="https://tray.io">Tray.io</a> requires me to oversee the development of their marketing site.</p><p>Normally Gatsby websites build pretty fast. But at Tray.io our website has over 500 hundred thousand pages. We&#x27;ve definitely stress tested Gatsby.</p><p>So here&#x27;s a few tips that I learn&#x27;t along the way...</p><h2>Keep your queries in your component</h2><p>One issue that did arise when building out 500 hundred thousand generated pages was that we had unknowingly created 70 thousand <a href="https://www.gatsbyjs.org/docs/recipes/querying-data/#querying-data-with-a-page-query">page queries</a> instead of 1 static query.</p><p>The reason this happened was that we had moved the graphql query outside of the component:</p><pre><code>const query = graphql`
 query {
   allBlogPosts {
     title
   }
 }
`

const SampleComponent = () =&gt; (
  &lt;StaticQuery 
   query={query}
   render={data =&gt; {...}}
  /&gt;
)</code></pre><p>The reason why this happened was due to two things:</p><ol><li>We named our query <code>query</code> which is a <a href="https://www.gatsbyjs.org/docs/recipes/querying-data/#directions">special name in Gatsby</a> when they compile the page files (Note: changing the name still had the same effect).</li><li>The code which decompiles StaticQuery struggles with outside placed queries ( we&#x27;re still unsure on this)</li></ol><p>We saw an decrease in query times by switching to the hook version of <code>StaticQuery</code> :</p><pre><code>const { site } = useStaticQuery(
    graphql`
      query {
        site {
          siteMetadata {
            title
          }
        }
      }
    `
  )</code></pre><p>I think this worked because the <a href="https://github.com/gatsbyjs/gatsby/blob/dd344ac4ea292f8b29aa4c55cc08ebc0f19cd761/packages/gatsby/src/query/file-parser.js#L45">check for whether a hook is used is a lot simpler</a> compared to the complexity of checking the StaticQuery AST. Less complexity less bugs I guess.</p><h2>Stop using all in your queries</h2><p>If you&#x27;re querying for a single blog post then instead of doing an <code>all</code> with a filter, you can filter on the singular object. No more checks for whether <code>edges</code> has results:</p><pre><code>// before
query Test($slug: String) {
  post: allBlogPosts(limit: 1, filter: { slug: { eq: $slug } }) {
    edges {
      node {
        title
      }
    }
  }
}

// after
query Test($slug: String) {
  post: blogPost(slug: { eq: $slug }) {
    title
  }
}</code></pre><h2>Limit the amount of data passed to createPage</h2><p>You might be tempted like we were to pass down a huge query result to a <code>pageContext</code> during build time. But you&#x27;d be mistaken...</p><p>The <code>pageContext</code> is type checked during the build process as it&#x27;s passed to a page query (<a href="https://www.gatsbyjs.org/docs/scaling-issues/#switch-off-type-inference-for-sitepagecontext">You can turn this off</a> but I don&#x27;t recommend it).</p><p>Instead pass down the slug of the page and use a <code>StaticQuery</code> to fetch a one time huge query result.</p></div></article></div></section></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{"siteTitle":"Kameron","slug":"optimizing-gatsby","content":"\nI've been getting cuddly with [Gatsby](https://www.gatsbyjs.org/) over the last 5 months as my new role at [Tray.io](https://tray.io) requires me to oversee the development of their marketing site.\n\nNormally Gatsby websites build pretty fast. But at Tray.io our website has over 500 hundred thousand pages. We've definitely stress tested Gatsby.\n\nSo here's a few tips that I learn't along the way...\n\n## Keep your queries in your component\n\nOne issue that did arise when building out 500 hundred thousand generated pages was that we had unknowingly created 70 thousand [page queries](https://www.gatsbyjs.org/docs/recipes/querying-data/#querying-data-with-a-page-query) instead of 1 static query.\n\nThe reason this happened was that we had moved the graphql query outside of the component:\n\n    const query = graphql`\n     query {\n       allBlogPosts {\n         title\n       }\n     }\n    `\n    \n    const SampleComponent = () =\u003e (\n      \u003cStaticQuery \n       query={query}\n       render={data =\u003e {...}}\n      /\u003e\n    )\n    \n\nThe reason why this happened was due to two things:\n\n1.  We named our query `query` which is a [special name in Gatsby](https://www.gatsbyjs.org/docs/recipes/querying-data/#directions) when they compile the page files (Note: changing the name still had the same effect).\n2.  The code which decompiles StaticQuery struggles with outside placed queries ( we're still unsure on this)\n\nWe saw an decrease in query times by switching to the hook version of `StaticQuery` :\n\n    const { site } = useStaticQuery(\n        graphql`\n          query {\n            site {\n              siteMetadata {\n                title\n              }\n            }\n          }\n        `\n      )\n    \n\nI think this worked because the [check for whether a hook is used is a lot simpler](https://github.com/gatsbyjs/gatsby/blob/dd344ac4ea292f8b29aa4c55cc08ebc0f19cd761/packages/gatsby/src/query/file-parser.js#L45) compared to the complexity of checking the StaticQuery AST. Less complexity less bugs I guess.\n\n## Stop using all in your queries\n\nIf you're querying for a single blog post then instead of doing an `all` with a filter, you can filter on the singular object. No more checks for whether `edges` has results:\n\n    // before\n    query Test($slug: String) {\n      post: allBlogPosts(limit: 1, filter: { slug: { eq: $slug } }) {\n        edges {\n          node {\n            title\n          }\n        }\n      }\n    }\n    \n    // after\n    query Test($slug: String) {\n      post: blogPost(slug: { eq: $slug }) {\n        title\n      }\n    }\n    \n\n## Limit the amount of data passed to createPage\n\nYou might be tempted like we were to pass down a huge query result to a `pageContext` during build time. But you'd be mistaken...\n\nThe `pageContext` is type checked during the build process as it's passed to a page query ([You can turn this off](https://www.gatsbyjs.org/docs/scaling-issues/#switch-off-type-inference-for-sitepagecontext) but I don't recommend it).\n\nInstead pass down the slug of the page and use a `StaticQuery` to fetch a one time huge query result.","data":{"author":"Kameron Tanseli","date":"2020-05-01T09:21:18.000Z","hero_image":"../static/posts/34442516-fb1a1a3c-ecc2-11e7-8fe8-530435f22336.jpg","title":"Optimizing Gatsby"},"isEmpty":false,"excerpt":""}},"page":"/blog/[slug]","query":{"slug":"optimizing-gatsby"},"buildId":"sKigvmBxHeR5ojdFW8lLh","dynamicBuildId":false,"nextExport":true}</script><script async="" id="__NEXT_PAGE__/blog/[slug]" src="/_next/static/sKigvmBxHeR5ojdFW8lLh/pages/blog/[slug].js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/sKigvmBxHeR5ojdFW8lLh/pages/_app.js"></script><script src="/_next/static/runtime/webpack-e1f7b6ddb3fae2db1f5d.js" async=""></script><script src="/_next/static/chunks/commons.0647a33e7070b3b816f2.js" async=""></script><script src="/_next/static/runtime/main-f116230a2e83c52060c3.js" async=""></script></body></html>